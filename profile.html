<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Krishi Connect | Profile & Tokens</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff; --text:#172022; --muted:#6b7a6f;
  --card-bg:rgba(255,255,255,0.96); --accent:#2f6f2f;
  --accent-2:#f39c12; --shadow: rgba(7,10,7,0.08);
}
[data-theme="dark"]{
  --bg:#0b1310; --text:#dfeee3; --muted:#9fb09a;
  --card-bg:rgba(6,12,8,0.78); --accent:#9ad58b;
  --accent-2:#f2c94c; --shadow: rgba(0,0,0,0.45);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}
a{text-decoration:none;color:inherit}

/* Top strip */
.header-bar{
  padding:12px 16px;
  display:flex;
  align-items:center;
  gap:10px;
  background:rgba(255,255,255,0.96);
  box-shadow:0 6px 18px var(--shadow);
}
[data-theme="dark"] .header-bar{
  background:rgba(10,16,12,0.98);
}
.app-title{
  font-family:'Playfair Display',serif;
  font-size:22px;
  font-weight:700;
}
.app-title span.krishi{color:var(--accent-2);}
.app-title span.connect{color:var(--accent);}
.theme-toggle{
  margin-left:auto;
}
.theme-toggle button{
  border-radius:999px;
  border:1px solid rgba(0,0,0,0.12);
  padding:6px 10px;
  cursor:pointer;
  background:transparent;
}

/* Layout */
.wrapper{
  max-width:960px;
  margin:24px auto 40px;
  padding:0 16px;
}
.grid{
  display:grid;
  grid-template-columns:1.1fr 1fr;
  gap:16px;
}
@media(max-width:880px){
  .grid{grid-template-columns:1fr;}
}

/* Card */
.card{
  background:var(--card-bg);
  border-radius:14px;
  padding:14px;
  box-shadow:0 10px 26px var(--shadow);
  margin-bottom:18px;
}
.section-title{
  font-size:17px;
  font-weight:800;
  color:var(--accent);
  display:flex;
  align-items:center;
  gap:8px;
}
.muted{
  color:var(--muted);
  font-size:13px;
  margin-top:6px;
}

/* Profile header */
.profile-main{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:10px;
}
.profile-avatar-big{
  width:70px;height:70px;
  border-radius:50%;
  background:linear-gradient(135deg,#fcd34d,#22c55e);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:30px;
  color:#111827;
}
.profile-info-main{
  flex:1;
}
.profile-name{
  font-size:18px;
  font-weight:700;
}
.profile-email{
  font-size:13px;
  color:var(--muted);
}
.profile-meta{
  font-size:12px;
  margin-top:4px;
}
.tag{
  display:inline-block;
  border-radius:999px;
  background:#ecfdf3;
  padding:4px 10px;
  font-size:11px;
  font-weight:600;
  color:#166534;
  margin-top:4px;
  margin-right:4px;
}

/* Stats */
.stats-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.stat-pill{
  flex:1;
  min-width:150px;
  background:#f9fafb;
  border-radius:12px;
  padding:10px;
  text-align:left;
  border:1px solid #e5e7eb;
}
.stat-label{
  font-size:12px;
  color:var(--muted);
}
.stat-value{
  font-size:20px;
  font-weight:800;
  margin-top:4px;
  color:var(--accent);
}

/* Token progress */
.token-bar-wrap{
  height:14px;
  border-radius:7px;
  background:#e5f7df;
  overflow:hidden;
}
.token-bar-inner{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#fcd34d,#22c55e);
  transition:width .4s ease-out;
}
.badge{
  display:inline-flex;
  align-items:center;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  background:#fef9c3;
  color:#92400e;
  margin-top:4px;
}

button{
  border:none;
  cursor:pointer;
  font-weight:700;
}
.btn-main{
  background:var(--accent);
  color:#fff;
  padding:8px 14px;
  border-radius:10px;
}
.btn-ghost{
  background:transparent;
  border-radius:10px;
  border:1px solid #d0d0d0;
  padding:8px 12px;
  font-weight:600;
}

/* small timeline-like list */
.timeline{
  margin-top:8px;
  font-size:13px;
}
.timeline-entry{
  padding:6px 8px;
  border-radius:8px;
  background:#f9fafb;
  margin-bottom:4px;
}
footer{
  text-align:center;
  font-size:12px;
  color:var(--muted);
  margin-top:20px;
}
</style>
</head>
<body data-theme="light">

<div class="header-bar">
  <div class="app-title">
    <span class="krishi">üåæ KRISHI</span> <span class="connect">CONNECT</span>
  </div>
  <a href="index.html" style="margin-left:16px;font-size:13px;font-weight:600;">‚¨Ö Back to main dashboard</a>
  <div class="theme-toggle">
    <button id="themeToggle">üåô / ‚òÄÔ∏è</button>
  </div>
</div>

<div class="wrapper">

  <div class="grid">
    <!-- LEFT: PROFILE -->
    <div>
      <div class="card">
        <div class="section-title">üë§ Farmer Profile</div>
        <p class="muted">
          This profile is taken from your login (Firebase Auth) and stored in your browser as <code>krishiAuthUser</code>.
        </p>

        <div class="profile-main">
          <div class="profile-avatar-big" id="pfAvatar">F</div>
          <div class="profile-info-main">
            <div class="profile-name" id="pfName">(Guest)</div>
            <div class="profile-email" id="pfEmail">Not logged in</div>
            <div class="profile-meta" id="pfMeta"></div>
            <div>
              <span class="tag" id="pfLoginTag">Local demo</span>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-main" id="goIndexBtn">Go to Krishi Connect</button>
          <button class="btn-ghost" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">üßæ Visit / Session Info</div>
        <p class="muted">
          High-level summary of your total usage and visit days, used to calculate Krishi Tokens.
        </p>
        <div class="timeline" id="visitTimeline"></div>
      </div>
    </div>

    <!-- RIGHT: TOKENS & TIME -->
    <div>
      <div class="card">
        <div class="section-title">üí∞ Krishi Tokens & Time</div>
        <p class="muted">
          Tokens are earned automatically from your usage time on Krishi Connect pages:
          <ul style="margin-left:18px;margin-top:4px;font-size:12px;">
            <li>Every full minute = <strong>2 tokens</strong></li>
            <li>Each day you open Krishi Connect = <strong>10 tokens</strong></li>
          </ul>
        </p>

        <div class="stats-row">
          <div class="stat-pill">
            <div class="stat-label">Total Tokens</div>
            <div class="stat-value" id="stTokens">0</div>
          </div>
          <div class="stat-pill">
            <div class="stat-label">Total Usage Time</div>
            <div class="stat-value" id="stUsage">0 min 0 s</div>
          </div>
          <div class="stat-pill">
            <div class="stat-label">Total Visit Days</div>
            <div class="stat-value" id="stVisits">0</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span class="muted" style="margin:0;font-size:12px;">Progress to next reward (100 tokens)</span>
            <span id="stNext" style="font-size:12px;font-weight:600;color:var(--accent)"></span>
          </div>
          <div class="token-bar-wrap">
            <div class="token-bar-inner" id="tokenBar"></div>
          </div>
          <div class="badge" id="stTierBadge" style="margin-top:6px">Seed Farmer üå±</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-main" id="recalcBtn">Recalculate from usage</button>
          <button class="btn-ghost" id="resetBtn">Reset token & usage data</button>
        </div>

        <p class="muted" style="margin-top:8px;">
          Reset is only for this browser and does not affect your login. Visit days & usage will start fresh.
        </p>
      </div>
    </div>
  </div>

  <footer>
    ¬© 2025 Krishi Connect ‚Äî Profile & Token Dashboard
  </footer>
</div>

<script>
/* usage tracking here as well */
let pageStart = Date.now();
function updateUsage(deltaMs){
  if(deltaMs <= 0) return;
  try{
    let total = parseInt(localStorage.getItem('krishiUsageMs') || '0', 10);
    if(isNaN(total) || total < 0) total = 0;
    total += deltaMs;
    localStorage.setItem('krishiUsageMs', String(total));

    const today = new Date().toISOString().slice(0,10);
    let days = [];
    try{
      days = JSON.parse(localStorage.getItem('krishiVisitDays') || '[]');
      if(!Array.isArray(days)) days = [];
    }catch(e){ days = []; }
    if(!days.includes(today)){
      days.push(today);
      localStorage.setItem('krishiVisitDays', JSON.stringify(days));
    }
  }catch(e){}
}
window.addEventListener('beforeunload', ()=>{
  const delta = Date.now() - pageStart;
  updateUsage(delta);
});

/* theme */
const themeBtn = document.getElementById('themeToggle');
function applyTheme(theme){
  document.body.setAttribute('data-theme', theme);
  try{ localStorage.setItem('krishi_theme', theme); }catch(e){}
}
(function initTheme(){
  try{
    const t = localStorage.getItem('krishi_theme') || 'light';
    applyTheme(t);
  }catch(e){
    applyTheme('light');
  }
})();
themeBtn.addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme') || 'light';
  applyTheme(cur === 'light' ? 'dark' : 'light');
});

/* storage helpers */
function readJson(key,fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){return fallback;}
}
function writeJson(key,val){
  try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
}

/* load auth user */
function loadAuthUser(){
  let u = null;
  try{
    u = JSON.parse(localStorage.getItem('krishiAuthUser') || 'null');
  }catch(e){ u = null; }
  const pfAvatar = document.getElementById('pfAvatar');
  const pfName = document.getElementById('pfName');
  const pfEmail = document.getElementById('pfEmail');
  const pfMeta = document.getElementById('pfMeta');
  const pfLoginTag = document.getElementById('pfLoginTag');

  if(u && u.email){
    const name = u.displayName || u.email.split('@')[0];
    pfName.textContent = name;
    pfEmail.textContent = u.email;
    pfAvatar.textContent = (name[0]||'F').toUpperCase();
    const provider = u.providerId || 'password';
    pfMeta.textContent = `Logged in via ${provider} ‚Ä¢ Last login: ${u.lastLoginAt || '-'}`;
    pfLoginTag.textContent = 'Signed-in farmer';
  }else{
    pfName.textContent = '(Guest)';
    pfEmail.textContent = 'Not logged in';
    pfAvatar.textContent = 'G';
    pfMeta.textContent = 'You are viewing the demo profile (no login found).';
    pfLoginTag.textContent = 'Guest mode';
  }
}
loadAuthUser();

/* go to index / logout */
document.getElementById('goIndexBtn').addEventListener('click', ()=>{
  window.location.href = 'index.html';
});
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  try{ localStorage.removeItem('krishiAuthUser'); }catch(e){}
  loadAuthUser();
  window.location.href = 'login.html';
});

/* tokens from usage (same formula as index) */
function calculateTokensFromUsage(){
  const usageMs = parseInt(localStorage.getItem('krishiUsageMs') || '0',10);
  const visitDays = readJson('krishiVisitDays', []);
  const totalMinutes = Math.floor(usageMs / 60000);
  const tokensFromTime = totalMinutes * 2;
  const tokensFromVisits = (visitDays?visitDays.length:0) * 10;
  const totalTokens = tokensFromTime + tokensFromVisits;
  const obj = { totalTokens, lastCalcAt:new Date().toISOString() };
  writeJson('krishiTokens', obj);
  return obj;
}
function loadTokenStats(){
  let obj = readJson('krishiTokens', null);
  if(!obj) obj = calculateTokensFromUsage();

  const usageMs = parseInt(localStorage.getItem('krishiUsageMs') || '0',10);
  const visitDays = readJson('krishiVisitDays', []);
  const totalSeconds = Math.floor(usageMs / 1000);
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;

  document.getElementById('stTokens').textContent = obj.totalTokens || 0;
  document.getElementById('stUsage').textContent = `${minutes} min ${seconds} s`;
  document.getElementById('stVisits').textContent = visitDays.length || 0;

  const bar = document.getElementById('tokenBar');
  const nextSpan = document.getElementById('stNext');
  const badge = document.getElementById('stTierBadge');
  const t = obj.totalTokens || 0;
  const pct = Math.min(100, (t % 100));
  bar.style.width = pct + '%';
  const remaining = 100 - (t % 100);
  nextSpan.textContent = `${remaining} tokens to next 100`;

  let tier = 'Seed Farmer üå±';
  if(t >= 500) tier = 'Gold Farmer üèÖ';
  else if(t >= 300) tier = 'Silver Farmer ü•à';
  else if(t >= 150) tier = 'Bronze Farmer ü•â';
  badge.textContent = tier;

  renderVisitTimeline(visitDays, usageMs, obj.totalTokens);
}

/* visit timeline small summary */
function renderVisitTimeline(visitDays, usageMs, tokens){
  const timeline = document.getElementById('visitTimeline');
  timeline.innerHTML = '';
  const today = new Date().toISOString().slice(0,10);
  const daysCount = visitDays.length;
  const totalMin = Math.floor(usageMs/60000);
  const totalSec = Math.floor((usageMs/1000)%60);

  const e1 = document.createElement('div');
  e1.className='timeline-entry';
  e1.textContent = `Total time across pages: ${totalMin} min ${totalSec} s.`;
  timeline.appendChild(e1);

  const e2 = document.createElement('div');
  e2.className='timeline-entry';
  e2.textContent = `Total visit days recorded: ${daysCount}.`;
  timeline.appendChild(e2);

  const e3 = document.createElement('div');
  e3.className='timeline-entry';
  e3.textContent = `Today (${today}) is ${visitDays.includes(today)?'already counted':'not yet counted'} in visit days list.`;
  timeline.appendChild(e3);

  const e4 = document.createElement('div');
  e4.className='timeline-entry';
  e4.textContent = `Current token balance (before redeem): ${tokens}.`;
  timeline.appendChild(e4);
}

/* recalc & reset buttons */
document.getElementById('recalcBtn').addEventListener('click', ()=>{
  calculateTokensFromUsage();
  loadTokenStats();
  alert('Tokens recalculated from usage/time data.');
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  localStorage.removeItem('krishiTokens');
  localStorage.removeItem('krishiUsageMs');
  localStorage.removeItem('krishiVisitDays');
  calculateTokensFromUsage();
  loadTokenStats();
  alert('Usage & token data reset for this browser.');
});

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  loadTokenStats();
});
</script>

</body>
</html>
